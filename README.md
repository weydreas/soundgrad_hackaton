# SoundGradient — Mood Playlist Generator (GigaChat)

SoundGradient — локальное веб‑приложение на Python, которое:

1) принимает изображение от пользователя через веб‑интерфейс;  
2) отправляет его в GigaChat для анализа “настроения”;  
3) получает теги;  
4) по тегам подбирает плейлист из локального списка песен (выводятся только названия).

Репозиторий предполагает публикацию **трёх файлов**: код + 2 текстовых файла со справочниками.

---

## Содержимое репозитория

```
SoundGradient/
├─ SoundGradient_v7.py        # основной код (версия 7)
├─ Tags.txt                   # список допустимых тегов настроения
├─ Songs.txt                  # список песен и их тегов
└─ README.md                  # этот файл
```

---

## Требования

- Python 3.10+ (желательно 3.11+)
- ОС: Windows / macOS / Linux
- Доступ к GigaChat API (клиентские креды → Basic key)

Зависимости Python:

- flask
- flask-session
- requests
- python-dotenv
- pillow

---

## Установка

### 1) Клонирование репозитория

```bash
git clone <your-repo-url>
cd SoundGradient
```

### 2) Установка зависимостей

```bash
python -m pip install flask flask-session requests python-dotenv pillow
```

Если `pip` не находится, используйте именно `python -m pip ...` как выше.

---

## Запуск

Из директории проекта:

```bash
python SoundGradient_v7.py
```

После запуска открой в браузере:

```
http://127.0.0.1:8000
```

---

## Использование

### 1) (Опционально) SSL Verify

В интерфейсе есть переключатель **Disable SSL verification (unsafe, for debug)**.

- По умолчанию проверка SSL включена (безопасно).
- Отключение SSL полезно в корпоративных сетях с TLS‑инспекцией (MITM), когда Python ругается на сертификаты.
- Используйте отключение SSL **только для отладки**.

### 2) Получение токена GigaChat

В интерфейсе введи **Authorization key** формата **Basic** (base64).

Обычно это:

```
base64(client_id:client_secret)
```

Далее нажми **«Получить токен и сохранить»**.

Интерфейс отображает статус токена:
- **нет токена**
- **валиден**
- **токен устарел**

Также показывается:
- время получения
- время истечения
- сколько секунд осталось

Токен считается живущим ~30 минут (в коде реализована проверка срока).

### 3) Анализ изображения

1. Выбери файл изображения и нажми **«Собрать плейлист»**.
2. Во время запроса кнопка блокируется, показывается спиннер и “прогресс‑полоса”.
3. Результат: теги + 3 трека (названия).

---

## Формат Tags.txt

Одна строка — один допустимый тег. Пустые строки и комментарии (строки, начинающиеся с `#`) игнорируются.

Пример:

```
dreamy
energetic
nocturnal
sad
jazz
```

---

## Формат Songs.txt

Одна строка — одна песня. Теги указываются в круглых скобках, через запятую.

```
Название песни (tag1, tag2, tag3)
```

Пример:

```
Kevin MacLeod – Gymnopedie No 1 (sad, dreamy)
Elijah K - neon ghost (nocturnal, energetic)
```

Важно:
- теги песни учитываются только если они присутствуют в `Tags.txt`;
- если у песни нет тегов — она всё равно может попасть в плейлист как “запасной” вариант.

---

## Как строится плейлист

1) GigaChat возвращает 3–8 тегов (строго из списка `Tags.txt`).  
2) Для каждой песни считается пересечение тегов песни и тегов изображения.  
3) Песни с пересечением > 0 имеют приоритет.  
4) Итоговый плейлист — **3 песни** в случайном порядке.

---

## Защита от лимитов API (429 Too Many Requests)

В версии 7 включены:

- **cooldown** между анализами на стороне сервера;
- **защита от параллельных запросов** (анализ “уже выполняется”);
- **retry/backoff** при 429 (учитывает `Retry-After`, если приходит);
- **кэширование** результата для одинаковых картинок (по sha256 байтов).

---

## Ошибка 413 (Request Entity Too Large)

Изображение перед отправкой автоматически:
- уменьшается по стороне,
- сжимается в JPEG,
- затем кодируется в base64.

Это снижает вероятность 413. Если 413 всё равно возникает — уменьшай параметры сжатия в функции `compress_image_for_prompt(...)`.

---

## Кэш

Кэш хранится в памяти процесса:

- ключ: sha256 исходных байтов файла
- значение: теги + плейлист
- TTL по умолчанию: 15 минут
- ограничение размера: 256 элементов

---

## Логи и диагностика

Ошибки и стек‑трейсы пишутся в файл:

```
SoundGradient_error.log
```

Если приложение “падает” при запуске — в логе будет причина (например, не установлены зависимости).

---

## Параметры конфигурации (опционально через env)

Можно переопределять через переменные окружения:

- `GIGACHAT_OAUTH_URL`
- `GIGACHAT_API_BASE`
- `GIGACHAT_MODEL`
- `TAGS_FILE`
- `SONGS_FILE`
- `SEND_IMAGE_TO_MODEL` (0/1)
- `FLASK_SECRET_KEY`

---

## Ограничения и замечания

- Запускается Flask dev server. Для production используйте WSGI сервер (gunicorn/uwsgi/waitress).
- Для работы требуется доступ к GigaChat API.
- Отключение SSL‑проверки небезопасно — только для отладки.

---

## License

Добавь лицензию по своему выбору (MIT/Apache-2.0/Proprietary).  
Если не уверен — обычно для open-source берут MIT.

